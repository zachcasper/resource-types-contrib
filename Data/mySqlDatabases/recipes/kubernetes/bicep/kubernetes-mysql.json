{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "2.0",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.38.33.27573",
      "templateHash": "4894455809496921725"
    }
  },
  "parameters": {
    "context": {
      "type": "object",
      "metadata": {
        "description": "Information about what resource is calling this Recipe. Generated by Radius. For more information visit https://docs.radapp.io/reference/context-schema/ "
      }
    },
    "database": {
      "type": "string",
      "defaultValue": "[coalesce(tryGet(parameters('context').resource.properties, 'database'), format('{0}', parameters('context').application.name))]",
      "metadata": {
        "description": "Name of the MySQL database. Defaults to the application name."
      }
    },
    "username": {
      "type": "string",
      "defaultValue": "[coalesce(tryGet(parameters('context').resource.properties, 'username'), format('{0}-user', parameters('context').application.name))]",
      "metadata": {
        "description": "MySQL username. Defaults to <application-name>-user"
      }
    },
    "version": {
      "type": "string",
      "defaultValue": "[coalesce(tryGet(parameters('context').resource.properties, 'version'), '8.4')]",
      "allowedValues": [
        "5.7",
        "8.0",
        "8.4"
      ],
      "metadata": {
        "description": "The major MySQL server version in the X.Y format. Defaults to the version 8.4 if not provided."
      }
    }
  },
  "variables": {
    "uniqueName": "[format('mysql-{0}', uniqueString(parameters('context').resource.id))]",
    "mySqlImage": "[format('mysql:{0}', parameters('version'))]",
    "port": 3306,
    "password": "[uniqueString(parameters('context').resource.id, guid(variables('uniqueName'), parameters('username')))]",
    "root_password": "[uniqueString(parameters('context').resource.id, guid(variables('uniqueName'), 'root'))]"
  },
  "imports": {
    "kubernetes": {
      "provider": "Kubernetes",
      "version": "1.0.0",
      "config": {
        "kubeConfig": "",
        "namespace": "[parameters('context').runtime.kubernetes.namespace]"
      }
    }
  },
  "resources": {
    "mySql": {
      "import": "kubernetes",
      "type": "apps/Deployment@v1",
      "properties": {
        "metadata": {
          "name": "[variables('uniqueName')]"
        },
        "spec": {
          "selector": {
            "matchLabels": {
              "app": "[parameters('context').application.name]",
              "resource": "[parameters('context').resource.name]"
            }
          },
          "template": {
            "metadata": {
              "labels": {
                "app": "[parameters('context').application.name]",
                "resource": "[parameters('context').resource.name]",
                "radapp.io/application": "[if(equals(parameters('context').application, null()), '', parameters('context').application.name)]"
              }
            },
            "spec": {
              "containers": [
                {
                  "name": "mysql",
                  "image": "[variables('mySqlImage')]",
                  "ports": [
                    {
                      "containerPort": "[variables('port')]"
                    }
                  ],
                  "env": [
                    {
                      "name": "MYSQL_ROOT_PASSWORD",
                      "value": "[variables('root_password')]"
                    },
                    {
                      "name": "MYSQL_USER",
                      "value": "[parameters('username')]"
                    },
                    {
                      "name": "MYSQL_PASSWORD",
                      "value": "[variables('password')]"
                    },
                    {
                      "name": "MYSQL_DATABASE",
                      "value": "[parameters('database')]"
                    }
                  ]
                }
              ]
            }
          }
        }
      }
    },
    "svc": {
      "import": "kubernetes",
      "type": "core/Service@v1",
      "properties": {
        "metadata": {
          "name": "[variables('uniqueName')]",
          "labels": {
            "app": "[parameters('context').application.name]",
            "resource": "[parameters('context').resource.name]",
            "radapp.io/application": "[if(equals(parameters('context').application, null()), '', parameters('context').application.name)]"
          }
        },
        "spec": {
          "type": "ClusterIP",
          "selector": {
            "app": "[parameters('context').application.name]",
            "resource": "[parameters('context').resource.name]"
          },
          "ports": [
            {
              "port": "[variables('port')]"
            }
          ]
        }
      }
    }
  },
  "outputs": {
    "result": {
      "type": "object",
      "value": {
        "resources": [
          "[format('/planes/kubernetes/local/namespaces/{0}/providers/core/Service/{1}', reference('svc').metadata.namespace, reference('svc').metadata.name)]",
          "[format('/planes/kubernetes/local/namespaces/{0}/providers/apps/Deployment/{1}', reference('mySql').metadata.namespace, reference('mySql').metadata.name)]"
        ],
        "values": {
          "host": "[format('{0}.{1}.svc.cluster.local', reference('svc').metadata.name, reference('svc').metadata.namespace)]",
          "port": "[variables('port')]",
          "database": "[parameters('database')]",
          "username": "[parameters('username')]"
        },
        "secrets": {
          "password": "[variables('password')]"
        }
      }
    }
  }
}